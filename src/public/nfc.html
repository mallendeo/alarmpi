<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFC: Open Door</title>
</head>
<body>
<script>
  ;(() => {
    'use strict'
    const request = (url, method = 'get', body) => fetch(url, {
      method,
      body,
      headers: {
        authorization: localStorage.getItem('authKey'),
        'Content-Type': 'application/json; charset=utf-8'
      }
    })

    const urlMatch = window.location.search.match(/pin=(.+)/)
    const pinName = (urlMatch && urlMatch[1]) ||Â 'doorRelay'

    request(`/api/datePing?now=${Date.now()}`)
      .then(res => res.json())
      .then(({ now, received }) => {
        const ping = Date.now() - now
        const timeDiff = received - now - ping
        return request(`/api/toggle/${pinName}`, 'post', JSON.stringify({ date: Date.now() + timeDiff }))
      })
      .then(() => {
        window.close()
      })
  })()
</script>
</body>
</html>